name: CI Build and Remote Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build (Maven or Ant)
        run: |
          if [ -f pom.xml ]; then
            mvn -B -DskipTests package
          elif [ -f build.xml ]; then
            ant clean dist
          else
            echo "No build file found"; exit 1
          fi

      - name: Upload WAR as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: war-file
          path: |
            target/*.war
            dist/*.war

      - name: Deploy to remote Tomcat via SCP and SSH
        if: ${{ secrets.DEPLOY_SSH_KEY && secrets.DEPLOY_HOST && secrets.DEPLOY_USER && secrets.DEPLOY_TOMCAT_PATH }}
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_TOMCAT_PATH: ${{ secrets.DEPLOY_TOMCAT_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          export WARFILE=$(ls target/*.war 2>/dev/null || ls dist/*.war)
          scp -i ~/.ssh/deploy_key "$WARFILE" "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_TOMCAT_PATH/webapps/"
          ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" "$DEPLOY_TOMCAT_PATH/bin/shutdown.sh || true; sleep 2; $DEPLOY_TOMCAT_PATH/bin/startup.sh"

    # Required repo secrets:
    # - DEPLOY_HOST
    # - DEPLOY_USER
    # - DEPLOY_SSH_KEY (private key)
    # - DEPLOY_TOMCAT_PATH
